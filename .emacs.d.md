
# ~/.emacs.d

- [General configuration](#general)
  - [User interface](#user-interface)
  - [Backups](#backups)
  - [History](#history)
  - [Summary](#general-summary)
- [Package management](#package-management)
  - [Straight.el](#org61c4bc9)
    - [Installation](#orgbd3d9d1)
    - [Usage](#org1a3dc74)
  - [Use-package](#org7e8a0f8)
    - [Installation](#orgc405f77)
    - [Using straight.el with use-package](#org48d489f)
    - [Usage](#org2fada32)
  - [Summary](#org3751166)
- [Evil](#evil)
  - ["Fix" the tab key for visibility cycling in Org and Evil mode](#evil-org-tab)
  - [Evil collection](#evil-collection)
  - [Evil commentary](#evil-commentary)
- [Org-mode](#org-mode)
  - [Exporting](#org81dd4e7)
  - [Org Roam](#org-roam)
  - [org-roam-ui](#orgd2d68f0)
  - [Org Babel](#org-babel)
- [Completion](#completion)
- [Flyspell](#flyspell)
- [Magit](#magit)
- [Eglot](#eglot)
- [Elixir](#elixir)
  - [elixir-ls](#elixir-ls)
- [Copy and paste](#copy-and-paste)
- [Feed reader](#orgab3266e)



<a id="general"></a>

## General configuration

The first part of the configuration file configures Emacs' main functionality. Since this doesn't require any of the plugins to load, it's placed first in the configuration file.

Loading it first has some advantages. For example, it prevents the hidden menu bar from flickering on startup.


<a id="user-interface"></a>

### User interface

By default, Emacs shows the menu bar at the top of the screen, which is accessed by pressing `<F10>`. To turn it off, set `menu-bar-mode` to a negative number:

```emacs-lisp
;; Hide the top menu bar
(menu-bar-mode -1)
```

On startup, Emacs shows the startup screen, which links to the manual and the tutorial. To open with a blank screen instead, set

```emacs-lisp
;; Disable the startup screen
(setq inhibit-startup-screen t)
```

Emacs also prints a message in the echo area that explains how to read more information about Emacs and the GNU system:

    For information about GNU Emacs and the GNU system, type C-h C-a.

To prevent this message from being printed, set `inihibit-startup-echo-area-message`:

```emacs-lisp
;; Disable the startup message
(setq inhibit-startup-echo-area-message t)
```


<a id="backups"></a>

### Backups

Instead of placing backup files (like `init.el~`) in the original file's directory, store them in `~/.emacs.d/backups/`:

```emacs-lisp
;; Store all backup files in =~/.emacs.d/backups/
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))
```

The `backup-directory-alist` lists cons cells with a regular expression and a directory name. In this setting, the regular expression is `"."`, meaning all files are stored in the specified directory.


<a id="history"></a>

### History

Commands executed through `M-x` are remembered to suggest them when pressing `M-x` again later. To execute a previously used command again, press `UP` in the minibuffer after pressing `M-x`.

Because the history is not saved, starting a new Emacs session loses all previously executed commands. To configure Emacs to periodically save the minibuffer history to a file and load it when starting a new session, enable `savehist-mode`:

```emacs-lisp
;; Save minibuffer history
(savehist-mode 1)
```

By default, Emacs saves the minibuffer history to `~/.emacs.d/history`.


<a id="general-summary"></a>

### Summary

The first part of the `init.el` file removes the menu bar and disables the startup screen and message:

```emacs-lisp
;; Hide the top menu bar
(menu-bar-mode -1)

;; Save minibuffer history
(savehist-mode 1)

(setq
 ;; Disable the startup screen
 inhibit-startup-screen t
 ;; Disable the startup message
 inhibit-startup-echo-area-message t
 ;; Store all backup files in =~/.emacs.d/backups/
 backup-directory-alist '(("." . "~/.emacs.d/backups")))
```


<a id="package-management"></a>

## Package management

Emacs includes a package manager named `package.el`, which installs packages from the official Emacs Lisp Package Archive, named [GNU ELPA.](https://elpa.gnu.org) GNU ELPA hosts a selection of packages, but most are available on [MELPA](https://melpa.org), which is an unofficial package archive that implements the ELPA specification. To use MELPA, it has to be [installed](https://melpa.org/#/getting-started) by adding it to the list of `package.el` package archives.

The built-in package manager installs packages through the `package-install` function. For example, to install the "evil-commentary" package from MELPA, call `package-install` inside Emacs:

`M-x` `package-install` `<RET>` `evil-commentary` `<RET>`


<a id="orgce38b11"></a>

### Straight.el

[Straight.el](https://github.com/raxod502/straight.el) is an alternative package manager that installs packages through Git checkouts instead of downloading tarballs from one of the package archives. Doing so allows installing forked packages, altering local package checkouts, and locking packages to exact versions for reproducable setups.


<a id="org88d9e0e"></a>

#### Installation

The [Getting started](https://github.com/raxod502/straight.el#getting-started) section in the straight.el README provides the bootstrap code to place inside `~/.emacs.d/init.el` in order to install it:

```emacs-lisp
;; Install straight.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
	(url-retrieve-synchronously
	 "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	 'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))
```

Straight.el uses package archives like GNU ELPA as registries to find the linked repositories to clone from. Since these are checked automatically, there's no need to add them to the list of package archives.

While package.el loads all installed packages on startup, straight.el only loads packages that are referenced in the init file. This allows for installing packages temporarily without slowing down Emacs' startup time on subsequent startups.

To create a truly reproducable setup, disable package.el in favor of straight.el by turning off `package-enable-at-startup`. Because this step needs to happen before package.el gets a chance to load packages, it this configuration needs to be set in the early init file:

```emacs-lisp
;; Disable package.el in favor of straight.el
(setq package-enable-at-startup nil)
```

With this configuration set, Emacs will only load the packages installed through straight.el.


<a id="org1a3dc74"></a>

#### Usage

To use straight.el to install a package for the current session, execute the `straight-use-package` command:

`M-x` `straight-use-package` `<RET>` `evil-commentary` `<RET>`

To continue using the package in future sessions, add the `straight-use-package` call to `~/.emacs/init.el`:

```emacs-lisp
(straight-use-package 'evil-commentary)
```

To update an installed package, execute the `straight-pull-package` command:

`M-x` `straight-pull-package` `<RET>` `evil-commentary` `<RET>`

To update the version lockfile, which is used to target the exact version to check out when installing, run `straight-freeze-versions`:

`M-x` `straight-freeze-versions` `<RET>`


<a id="org7e8a0f8"></a>

### Use-package

[Use-package](https://github.com/jwiegley/use-package) is a macro to configure and load packages in Emacs configurations. It interfaces with package managers like package.el or straight.el to install packages, but is not a package manager by itself.

For example, when using straight.el without use-package, installing and starting evil-commentary requires installing the package and starting it as two separate steps:

```emacs-lisp
(straight-use-package 'evil-commentary)
(evil-commentary-mode)
```

[Combined with use-package](#org48d489f), the installation and configuration are unified into a single call to `use-package`:

```emacs-lisp
(use-package evil-commentary
	     :config (evil-commentary-mode))
```

Aside from keeping configuration files tidy, having package configuration contained within a single call allows for more advanced package setups. For example, packages can be lazy-loaded, keeping their configuration code from executing until the package they configure is needed.


<a id="orgc405f77"></a>

#### Installation

To install use-package with straight.el, use `straight-use-package`:

```emacs-lisp
;; Install use-package
(straight-use-package 'use-package)
```


<a id="org48d489f"></a>

#### Using straight.el with use-package

By default, use-package uses package.el to install packages. To use straight.el instead of package.el, pass the `:straight` option:

```emacs-lisp
(use-package evil-commentary
	     :straight t)
```

To configure use-package to always use straight.el, use `use-package` to configure straight.el to turn on `straight-use-package-by-default`<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>:

```emacs-lisp
;; Configure use-package to use straight.el by default
(use-package straight
	     :custom (straight-use-package-by-default t))
```

Now, installing any package using use-package uses straight.el, even when omitting the `:straight.el` option.

Having both straight.el and use-package installed and configured to work together, the `straight-use-package` function isn't used anymore. Instead, all packages are installed and configured through use-package.


<a id="org2fada32"></a>

#### Usage

Use the `use-package` macro to load a package. If the package is not installed yet, it is installed automatically:

```emacs-lisp
(use-package evil-commentary)
```

Use-package provides keywords to add configuration, key bindings and variables. Although there are [many more options](https://github.com/jwiegley/use-package#getting-started/), some examples include `:config`, `:init`, `:bind`, and `:custom`:

-   **`:config` and `:init`:** The `:config` and `:init` configuration keywords define code that's run right after, or right before a package is loaded, respectively.
    
    For example, call `evil-mode` from the `:config` keyword to start Evil after loading its package. To [turn off `evil-want-C-i-jump`](../notes/publish/.emacs.d/emacs-evil-org-tab.md) right before evil is loaded (instead of adding it to the early init file), configure it in the `:init` keyword:
    
    ```emacs-lisp
    (use-package evil
    	     :init (setq evil-want-C-i-jump nil)
    	     :config (evil-mode))
    ```

-   **`:bind`:** Adds key bindings after a module is loaded. For example, to use `consult-buffer` instead of the built-in `switch-to-buffer` after loading the consult package, add a binding through the `:bind` keyword:
    
    ```emacs-lisp
    (use-package consult
    	     :bind ("C-x b" . consult-buffer)
    ```

-   **`:custom`:** Sets customizable variables. The variables set through use-package are not saved in Emacs' custom file. Instead, all custom variables are expected to be set through use-package. In an example from before, the `:custom` keyword is used to set the `straight-use-package-by-default` configuration option after loading straight.el:
    
    ```emacs-lisp
    (use-package straight
    	     :custom (straight-use-package-by-default t))
    ```


<a id="org3751166"></a>

### Summary

The resulting `~/.emacs.d/init.el` file installs straight.el and use-package, and configures straight.el as the package manager for use-package to use:

```emacs-lisp
;; Install straight.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
	(url-retrieve-synchronously
	 "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	 'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; Install use-package
(straight-use-package 'use-package)

;; Configure use-package to use straight.el by default
(use-package straight
	     :custom (straight-use-package-by-default t))
```

The `~/.emacs.d/early-init.el` file disables package.el to disable its auto-loading, causing all packages to be loaded through straight.el in the init file:

```emacs-lisp
;; Disable package.el in favor of straight.el
(setq package-enable-at-startup nil)
```

This is the only configuration set in the early init file. All other packages are installed and configured through use-package, which makes sure to load configuration options before packages are loaded, if configured with the `:init` keyword.


<a id="evil"></a>

## Evil

[Evil](https://github.com/emacs-evil/evil) is a Vim emulator for emacs. Install it with `straight.el`, and turn `evil-mode` on:

```emacs-lisp
;; Vim emulation: evil
(straight-use-package 'evil)
(evil-mode 1)
```


<a id="evil-org-tab"></a>

### "Fix" the tab key for visibility cycling in Org and Evil mode

Emacs' Org mode uses the `TAB` key to call `org-cycle`, which cycles visibility for headers. Every `TAB` press on a headline cycles through a different function<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>:

1.  The first press folds the headline's subtree, showing only the headline itself
2.  The scond press shows the headline and its direct descendants, but keeps them folded
3.  The third press shows the headline's complete subtree

However, running Emacs with Evil mode in a terminal breaks the `TAB` key for cycling through header visibility in Org mode.

Most terminals map both `TAB` and `C-i` to `U+0009 (Character Tabulation)` for historical reasons, meaning they're recognised as the same keypress. Because of this, there is no way to map different functions to them inside Emacs.

Evil remaps `C-i` to `evil-jump-forward` to emulate Vim's jump lists feature<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>, which overwrites the default mapping for the `TAB` key in Org mode.

To fix the tab key's functionality in Org mode, sacrifice Evil's `C-i` backward jumping by turning it off in your configuration with the `evil-want-C-i-jump` option. This option needs to be set *before* Evil is loaded to take effect, so put it in the early init file:

```emacs-lisp
;; Disable C-i to jump forward to restore TAB functionality in Org mode.
(setq evil-want-C-i-jump nil)
```


<a id="evil-collection"></a>

### Evil collection

[Evil collection](https://github.com/emacs-evil/evil-collection) is a collection of bindings for plugins.

```emacs-lisp
;; Vim bindings for plugins: evil-collection
(straight-use-package 'evil-collection)
(evil-collection-init)
```

Evil collection replaces Evil's `evil-integration`, which should be turned before Evil and Evil collection are loaded<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>. To do so, set the `evil-want-keybinding` configuration option to `nil` in the early init file:

```emacs-lisp
;; Disable evil-integration in favor of evil-collection.
(setq evil-want-keybinding nil)
```


<a id="evil-commentary"></a>

### Evil commentary

[Evil commentary](https://github.com/linktohack/evil-commentary) comments stuff out. It's an Emacs port of [commentary.vim](https://github.com/tpope/vim-commentary).

```emacs-lisp
;; Comment stuff out: Evil commentary
(straight-use-package 'evil-commentary)
(evil-commentary-mode)
```


<a id="org-mode"></a>

## Org-mode

[ox-gfm](https://github.com/larstvei/ox-gfm) is an Org export backend for GitHub-flavored Markdown.

```emacs-lisp
;; GitHub-flavored Markdown Org exporter: ox-gfm
(straight-use-package 'ox-gfm)
```

[htmlize](https://github.com/hniksic/emacs-htmlize) is an HTML syntax highlighter.

```emacs-lisp
;; Syntax highlighted HTML exports for code blocks: htmlize
(straight-use-package 'htmlize)
```


<a id="org81dd4e7"></a>

### Exporting

Org exports to HTML.

By default, the exported HTML files include default a stylesheet. To remove it, turn off `org-html-head-include-default-style`:

```emacs-lisp
;; Don't include default stylesheet in Org HTML export
(setq org-html-head-include-default-style nil)
```


<a id="org-roam"></a>

### Org Roam

[Org-roam](https://github.com/org-roam/org-roam) is a knowledge management system. Set the directory for notes to `~/notes/`.

```emacs-lisp
;; Org-roam
(straight-use-package 'org-roam)
(setq org-roam-directory (file-truename "~/notes/"))
(setq org-roam-v2-ack t)
(org-roam-setup)
```


<a id="orgd2d68f0"></a>

### org-roam-ui

```emacs-lisp
(straight-use-package 'websocket)

(straight-use-package
 '(org-roam-ui :host github :repo "org-roam/org-roam-ui" :branch "main" :files ("*.el" "out")))
```


<a id="org-babel"></a>

### Org Babel

Add "shell" to Babel's code execution languages.

```emacs-lisp
;; Add "shell" to Babel's code execution languages.
(org-babel-do-load-languages 'org-babel-load-languages '((shell . t) (ruby . t)))
```

Don't warn when evaluating code blocks:

```emacs-lisp
;; Don't warn when evaluating code blocks.
(setq org-confirm-babel-evaluate nil)
```


<a id="completion"></a>

## Completion

Inputs in commands like `M-x`, `C-x b` and `C-x C-f` are completed by prompting the user for input by showing a list of completion options.

```emacs-lisp
;; Completions: Vertico
(straight-use-package 'vertico)
(vertico-mode)
```


<a id="flyspell"></a>

## Flyspell

[Flyspell](https://www.emacswiki.org/emacs/FlySpell) is a minor mode that enables on-the-fly spell checking. It uses [GNU aspell](http://aspell.net), which is installed via Homebrew:

```shell
brew install aspell
```

To enable Flyspell in text-mode, add a hook:

```emacs-lisp
;; Spell checking: Flyspell
(add-hook 'text-mode-hook 'flyspell-mode)
```


<a id="magit"></a>

## Magit

[Magit](https://magit.vc) is an interface to Git.

```emacs-lisp
;; Git: magit
(straight-use-package 'magit)
```


<a id="eglot"></a>

## Eglot

[Eglot](https://github.com/joaotavora/eglot) is a language server protocol client.

```emacs-lisp
;; Language server client: Eglot
(straight-use-package 'eglot)
```


<a id="elixir"></a>

## Elixir

```emacs-lisp
;; Elixir: elixir-mode
(straight-use-package 'elixir-mode)
```

Automatically format Elixir files on save.

```emacs-lisp
;; Format Elixir files on save
(add-hook 'elixir-mode-hook
	  (lambda () (add-hook 'before-save-hook 'elixir-format nil t)))
```


<a id="elixir-ls"></a>

### elixir-ls

Check out the repository for elixir-ls inside the `~/.emacs.d/` directory, and build<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup> it using `mix elixir_ls.release`:

```shell
git clone git@github.com:elixir-lsp/elixir-ls.git ~/.emacs.d/elixir-ls
cd ~/.emacs.d/elixir-ls
mix deps.get
mix elixir_ls.release
```

In `~/.emacs.d/init.el`, add the path to the `language_server.sh` file to the server programs list:

```emacs-lisp
;; Add elixir-ls to Eglot's server programs list
;;(add-to-list 'eglot-server-programs '(elixir-mode "~/.emacs.d/elixir-ls/release/language_server.sh"))
```


<a id="copy-and-paste"></a>

## Copy and paste

[xclip](https://elpa.gnu.org/packages/xclip.html) is a package that allows Emacs to copy and paste from the GUI clipboard to enable copying and pasting text to and from terminal Emacs.

```emacs-lisp
;; Copy and paste: xclip
(straight-use-package 'xclip)
(xclip-mode 1)
```


<a id="orgab3266e"></a>

## Feed reader

```emacs-lisp
;; Feed reader: elfeed
(straight-use-package 'elfeed)
```

## Footnotes

<sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> Vim and Evil don't have a direct equivalent to fold cycling, but they have three different commands that achieve the same result:

1.  `zf` folds the headline's subtree
2.  `zo` opens the headline's subtree to show its direct descendants
3.  `zO` opens the complete subtree

<sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> Vim and Evil remember jumps between lines and files in the "jump list". Because the jump locations are stored, you can use `C-o` to jump to a previous location, and `C-i` to jump back. For example:

1.  To move to the next empty line, press `}` in normal mode
2.  To jump back to where you came from, press `C-o`
3.  To jump back to that empty line, press `C-i`

<sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> Evil collection prints a warning if it's loaded without `evil-want-keybinding` turned off:

    Warning (evil-collection): Make sure to set `evil-want-keybinding' to nil before loading evil or evil-collection.
    
    See https://github.com/emacs-evil/evil-collection/issues/60 for more details.

<sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> Because elixir-ls in a local repository, pull in changes through Git and rebuild the language server to update it in the future:

```shell
cd ~/.emacs.d/elixir-ls
git pull
mix deps.get
mix elixir_ls.release
```